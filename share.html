<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shared Analysis - LegalLens AI</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-brand">
        <i class="fas fa-gavel"></i>
        <span>LegalLens AI</span>
      </div>
      <div class="nav-links">
        <a href="index.html">Home</a>
        <div class="auth-buttons">
          <button id="theme-toggle" class="auth-btn" title="Toggle theme"><i class="fas fa-moon"></i></button>
        </div>
      </div>
    </div>
  </nav>

  <section class="hero">
    <div class="hero-container">
      <div class="hero-content">
        <h1 class="hero-title">Shared Analysis</h1>
        <p class="hero-subtitle">View-only link generated by a LegalLens user</p>
      </div>
    </div>
  </section>

  <main class="main-container">
    <div class="app-container">
      <div class="results-container">
        <div class="section-header">
          <h2><i class="fas fa-chart-line"></i> Analysis Results</h2>
          <p id="meta" style="opacity:.8"></p>
        </div>

        <div class="risk-assessment">
          <div class="card">
            <div class="card-header">
              <h3><i class="fas fa-shield-alt"></i> Risk Assessment</h3>
            </div>
            <div class="card-content">
              <div class="risk-meter">
                <div class="meter-container">
                  <div class="meter">
                    <div id="risk-bar" class="meter-bar"></div>
                  </div>
                  <div class="risk-labels">
                    <span>Low Risk</span>
                    <span>High Risk</span>
                  </div>
                </div>
                <div class="risk-score">
                  <span id="risk-text" class="risk-level">Risk Level</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="key-findings">
          <div class="card">
            <div class="card-header">
              <h3><i class="fas fa-exclamation-triangle"></i> Important Clauses</h3>
            </div>
            <div class="card-content">
              <div id="findings-list" class="findings-list"></div>
            </div>
          </div>
        </div>

        <div class="summary">
          <div class="card">
            <div class="card-header">
              <h3><i class="fas fa-file-alt"></i> Summary</h3>
            </div>
            <div class="card-content">
              <div id="summary-text" class="summary-content"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="footer-container">
      <div class="footer-content">
        <div class="footer-brand">
          <i class="fas fa-gavel"></i>
          <span>LegalLens AI</span>
        </div>
        <p>&copy; 2024 LegalLens AI. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
  <script src="config.js"></script>
  <script>
    // Theme toggle (reuse)
    (function(){
      const btn = document.getElementById('theme-toggle');
      function setTheme(mode){
        document.documentElement.setAttribute('data-theme', mode);
        document.body.setAttribute('data-theme', mode);
        if (btn) btn.innerHTML = mode === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
      }
      try { const saved = localStorage.getItem('ll_theme'); if (saved) setTheme(saved); } catch(e){}
      if (btn) btn.addEventListener('click', function(){
        const current = document.documentElement.getAttribute('data-theme') || 'light';
        const next = current === 'dark' ? 'light' : 'dark';
        setTheme(next); try { localStorage.setItem('ll_theme', next); } catch(e){}
      });
    })();

    // Firebase init (read-only)
    let firebaseDB;
    try {
      if (typeof firebase !== 'undefined') {
        let cfg = null;
        if (window.CONFIG && window.CONFIG.FIREBASE) cfg = window.CONFIG.FIREBASE;
        if (!cfg) throw new Error('Missing Firebase config');
        firebase.initializeApp(cfg);
        firebaseDB = firebase.firestore();
      }
    } catch (e) { console.log('Firebase init failed on share page:', e); }

    // Helpers
    function getParam(name){ const u = new URL(location.href); return u.searchParams.get(name); }

    function render(analysis){
      // risk
      const score = Number(analysis.risk_score || 0);
      const riskBar = document.getElementById('risk-bar');
      const riskText = document.getElementById('risk-text');
      riskBar.style.width = Math.max(0, Math.min(10, score)) * 10 + '%';
      if (score <= 3) { riskBar.className = 'meter-bar risk-low'; riskText.textContent = `Risk Level: Low (${score}/10)`; }
      else if (score <= 6) { riskBar.className = 'meter-bar risk-medium'; riskText.textContent = `Risk Level: Medium (${score}/10)`; }
      else { riskBar.className = 'meter-bar risk-high'; riskText.textContent = `Risk Level: High (${score}/10)`; }
      // key issues
      const list = document.getElementById('findings-list');
      list.innerHTML = (analysis.key_issues||[]).map(i => `<div class="finding-item"><span class="finding-icon">‚ö†Ô∏è</span><span class="finding-text">${i}</span></div>`).join('');
      // summary
      const summary = document.getElementById('summary-text');
      const typeBadge = analysis.document_type ? `<div class="document-type-badge">üìÑ ${analysis.document_type}</div>` : '';
      summary.innerHTML = `${typeBadge}<p>${analysis.plain_summary || ''}</p>`;
    }

    async function loadShared(){
      // 1) Hash-based offline share: #data=...
      const hash = location.hash || '';
      if (hash.startsWith('#data=')) {
        try {
          const enc = hash.slice(6);
          const json = (window.LZString && window.LZString.decompressFromEncodedURIComponent)
            ? window.LZString.decompressFromEncodedURIComponent(enc)
            : decodeURIComponent(atob(decodeURIComponent(enc)));
          const payload = JSON.parse(json || '{}');
          document.getElementById('meta').textContent = `Shared via link ‚Ä¢ ${new Date(payload.createdAt || Date.now()).toLocaleString()}`;
          render(payload.analysis || {});
          return;
        } catch (e) {
          console.error('Hash decode failed', e);
          alert('Invalid share link.');
          return;
        }
      }

      // 2) Firestore-backed share: ?id=...
      const id = getParam('id');
      if (!id) { alert('Missing share id'); return; }
      try {
        if (!firebaseDB) throw new Error('Database not ready');
        const snap = await firebaseDB.collection('sharedAnalyses').doc(id).get();
        if (!snap.exists) { alert('Link not found or expired'); return; }
        const data = snap.data();
        const owner = data.owner && data.owner.email ? `Shared by ${data.owner.email}` : 'Shared analysis';
        document.getElementById('meta').textContent = `${owner} ‚Ä¢ ${new Date(data.createdAt || Date.now()).toLocaleString()}`;
        render(data.analysis || {});
      } catch (e) {
        console.error('Failed to load shared analysis', e);
        alert('Unable to load this shared link.');
      }
    }

    document.addEventListener('DOMContentLoaded', loadShared);
  </script>
</body>
</html>
